<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Finance - Dashboard</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo-small">
                <span class="logo-icon">üíé</span>
                <span class="logo-text">Smart Finance</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" onclick="window.location.href='/dashboard'; return false;">
                <span class="nav-icon">üè†</span>
                <span class="nav-text">Resumen</span>
            </a>
            <a href="#" class="nav-item" onclick="window.location.href='/inversiones'; return false;">
                <span class="nav-icon">üìà</span>
                <span class="nav-text">Inversiones</span>
            </a>
            <a href="#" class="nav-item" onclick="window.location.href='/gastos'; return false;">
                <span class="nav-icon">üí∏</span>
                <span class="nav-text">Gastos</span>
            </a>
            <a href="#" class="nav-item" onclick="window.location.href='/analisis'; return false;">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">An√°lisis</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar">üë§</div>
                <div class="user-info">
                    <div class="user-name" id="sidebar-username">Usuario</div>
                    <div class="user-role" id="sidebar-role">user</div>
                </div>
            </div>
            <button class="btn-logout" id="logout-btn">
                <span>Cerrar Sesi√≥n</span>
                <span>üö™</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <h1 class="page-title">Resumen General</h1>
                <p class="page-subtitle">Vista general de tus finanzas</p>
            </div>
            <div class="header-right">
                <div class="header-stats">
                    <div class="stat-badge balance-badge" id="header-balance">
                        <span class="stat-label">Balance</span>
                        <span class="stat-value">$0</span>
                    </div>
                </div>
                <!-- Bot√≥n flotante del chatbot -->
                <button class="btn-chat-float" id="chat-toggle-btn" title="Asistente IA">
                    <span>ü§ñ</span>
                </button>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="cards-grid">
            <div class="stat-card stat-card-primary">
                <div class="stat-card-icon">üí∞</div>
                <div class="stat-card-content">
                    <div class="stat-card-label">Total Inversiones</div>
                    <div class="stat-card-value" id="total-inversiones">$0</div>
                    <div class="stat-card-change positive">+0% este mes</div>
                </div>
            </div>
            
            <div class="stat-card stat-card-danger">
                <div class="stat-card-icon">üí∏</div>
                <div class="stat-card-content">
                    <div class="stat-card-label">Total Gastos</div>
                    <div class="stat-card-value" id="total-gastos">$0</div>
                    <div class="stat-card-change negative">-0% este mes</div>
                </div>
            </div>
            
            <div class="stat-card stat-card-success">
                <div class="stat-card-icon">üìä</div>
                <div class="stat-card-content">
                    <div class="stat-card-label">Balance</div>
                    <div class="stat-card-value" id="balance">$0</div>
                    <div class="stat-card-change" id="ahorro-badge">0% de ahorro</div>
                </div>
            </div>
            
            <div class="stat-card stat-card-info">
                <div class="stat-card-icon">üéØ</div>
                <div class="stat-card-content">
                    <div class="stat-card-label">Porcentaje Ahorro</div>
                    <div class="stat-card-value" id="porcentaje-ahorro">0%</div>
                    <div class="stat-card-change">Meta: 20%</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-container">
            <div class="chart-card">
                <h3 class="chart-title">Distribuci√≥n de Gastos</h3>
                <div id="gastos-chart" class="chart-placeholder">
                    <div class="no-data">No hay datos disponibles</div>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">Distribuci√≥n de Inversiones</h3>
                <div id="inversiones-chart" class="chart-placeholder">
                    <div class="no-data">No hay datos disponibles</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
            <div class="stat-card" style="cursor: pointer;" onclick="window.location.href='/inversiones'">
                <div class="stat-card-icon">‚ûï</div>
                <div class="stat-card-content">
                    <div class="stat-card-label">Nueva Inversi√≥n</div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">Registra un nuevo ingreso</div>
                </div>
            </div>
            
            <div class="stat-card" style="cursor: pointer;" onclick="window.location.href='/gastos'">
                <div class="stat-card-icon">‚ûñ</div>
                <div class="stat-card-content">
                    <div class="stat-card-label">Nuevo Gasto</div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">Registra un nuevo egreso</div>
                </div>
            </div>
            
            <div class="stat-card" style="cursor: pointer;" onclick="window.location.href='/analisis'">
                <div class="stat-card-icon">üìä</div>
                <div class="stat-card-content">
                    <div class="stat-card-label">Ver An√°lisis</div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">Reportes detallados</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Chatbot -->
    <div id="chat-modal" class="modal-chat">
        <div class="chat-modal-content">
            <div class="chat-modal-header">
                <h3>ü§ñ Asistente Financiero IA</h3>
                <button class="chat-modal-close" id="chat-close-btn">&times;</button>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="chat-message bot-message">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <div class="message-text">¬°Hola! Soy tu asistente financiero IA. ¬øEn qu√© puedo ayudarte hoy?</div>
                    </div>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chat-input" placeholder="Escribe tu pregunta aqu√≠..." class="chat-input">
                <button id="chat-send" class="btn-send">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="toast"></div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';
        let token = null;
        let currentUser = null;

        // Verificar autenticaci√≥n
        function checkAuth() {
            token = localStorage.getItem('token');
            if (!token) {
                console.log('‚ùå No hay token, redirigiendo a login...');
                window.location.href = '/';
                return false;
            }
            console.log('‚úÖ Token encontrado');
            return true;
        }

        // Fetch autenticado
        async function authenticatedFetch(url, options = {}) {
            return fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
        }

        // Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Formatear moneda
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Obtener color por categor√≠a
        function getColorForCategory(category) {
            const colors = {
                'comida': '#10b981',
                'transporte': '#3b82f6',
                'servicios': '#f59e0b',
                'entretenimiento': '#8b5cf6',
                'salud': '#ef4444',
                'educaci√≥n': '#6366f1',
                'ropa': '#ec4899',
                'hogar': '#14b8a6',
                'trabajo': '#6366f1',
                'negocio': '#14b8a6',
                'arriendo': '#ec4899',
                'default': '#64748b'
            };
            return colors[category.toLowerCase()] || colors['default'];
        }

        // Cargar perfil
        async function loadUserProfile() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/users/profile`);
                if (!response.ok) throw new Error('Error al cargar perfil');
                currentUser = await response.json();
                
                const usernameEl = document.getElementById('sidebar-username');
                const roleEl = document.getElementById('sidebar-role');
                
                if (usernameEl) usernameEl.textContent = currentUser.username;
                if (roleEl) roleEl.textContent = currentUser.rol || 'user';
                
                return currentUser;
            } catch (error) {
                console.error('‚ùå Error cargando perfil:', error);
                localStorage.removeItem('token');
                window.location.href = '/';
            }
        }

        // Cargar datos del dashboard
        async function loadDashboardData() {
            try {
                const resumenResponse = await authenticatedFetch(`${API_BASE_URL}/analisis/resumen-general`);
                
                if (resumenResponse.ok) {
                    const resumen = await resumenResponse.json();
                    
                    document.getElementById('total-inversiones').textContent = formatCurrency(resumen.total_inversiones);
                    document.getElementById('total-gastos').textContent = formatCurrency(resumen.total_gastos);
                    document.getElementById('balance').textContent = formatCurrency(resumen.balance);
                    document.getElementById('porcentaje-ahorro').textContent = `${resumen.porcentaje_ahorro}%`;
                    
                    const headerBalance = document.getElementById('header-balance');
                    if (headerBalance) {
                        headerBalance.querySelector('.stat-value').textContent = formatCurrency(resumen.balance);
                    }
                    
                    const ahorroBadge = document.getElementById('ahorro-badge');
                    ahorroBadge.textContent = `${resumen.porcentaje_ahorro}% de ahorro`;
                    ahorroBadge.className = 'stat-card-change';
                    if (resumen.porcentaje_ahorro > 0) {
                        ahorroBadge.classList.add('positive');
                    } else {
                        ahorroBadge.classList.add('negative');
                    }
                }
                
                const gastosResponse = await authenticatedFetch(`${API_BASE_URL}/analisis/gastos-por-tipo`);
                if (gastosResponse.ok) {
                    const gastos = await gastosResponse.json();
                    renderGastosChart(gastos);
                }
                
                const inversionesResponse = await authenticatedFetch(`${API_BASE_URL}/analisis/inversiones-por-tipo`);
                if (inversionesResponse.ok) {
                    const inversiones = await inversionesResponse.json();
                    renderInversionesChart(inversiones);
                }
                
            } catch (error) {
                console.error('Error al cargar datos:', error);
            }
        }

        // Renderizar gr√°fico de gastos
        function renderGastosChart(data) {
            const chartContainer = document.getElementById('gastos-chart');
            
            if (!data || data.length === 0) {
                chartContainer.innerHTML = '<div class="no-data">No hay datos disponibles</div>';
                return;
            }
            
            let html = '<div class="chart-bars" style="padding: 20px;">';
            
            data.forEach(item => {
                const percentage = item.porcentaje;
                const color = getColorForCategory(item.tipo_gasto);
                
                html += `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600; text-transform: capitalize;">${item.tipo_gasto}</span>
                            <span style="color: var(--text-secondary);">${formatCurrency(item.total)} (${percentage.toFixed(1)}%)</span>
                        </div>
                        <div style="background: var(--bg-dark); height: 24px; border-radius: 12px; overflow: hidden;">
                            <div style="background: ${color}; height: 100%; width: ${percentage}%; transition: width 1s ease;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            chartContainer.innerHTML = html;
        }

        // Renderizar gr√°fico de inversiones
        function renderInversionesChart(data) {
            const chartContainer = document.getElementById('inversiones-chart');
            
            if (!data || data.length === 0) {
                chartContainer.innerHTML = '<div class="no-data">No hay datos disponibles</div>';
                return;
            }
            
            let html = '<div class="chart-bars" style="padding: 20px;">';
            
            data.forEach(item => {
                const percentage = item.porcentaje;
                const color = getColorForCategory(item.tipo_inversion);
                
                html += `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600; text-transform: capitalize;">${item.tipo_inversion}</span>
                            <span style="color: var(--text-secondary);">${formatCurrency(item.total)} (${percentage.toFixed(1)}%)</span>
                        </div>
                        <div style="background: var(--bg-dark); height: 24px; border-radius: 12px; overflow: hidden;">
                            <div style="background: ${color}; height: 100%; width: ${percentage}%; transition: width 1s ease;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            chartContainer.innerHTML = html;
        }

        // Configurar chatbot
        function setupChatbot() {
            const chatModal = document.getElementById('chat-modal');
            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            const chatCloseBtn = document.getElementById('chat-close-btn');
            const chatSendBtn = document.getElementById('chat-send');
            const chatInput = document.getElementById('chat-input');
            
            if (!chatModal || !chatToggleBtn) return;
            
            chatToggleBtn.addEventListener('click', () => {
                chatModal.classList.add('active');
                chatInput.focus();
            });
            
            if (chatCloseBtn) {
                chatCloseBtn.addEventListener('click', () => {
                    chatModal.classList.remove('active');
                });
            }
            
            if (chatSendBtn) {
                chatSendBtn.addEventListener('click', sendChatMessage);
            }
            
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
            
            chatModal.addEventListener('click', (e) => {
                if (e.target === chatModal) {
                    chatModal.classList.remove('active');
                }
            });
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage(message, 'user');
            input.value = '';
            input.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });
                
                if (!response.ok) {
                    throw new Error('Error en el chat');
                }
                
                const data = await response.json();
                
                if (data.error) {
                    addChatMessage(`Error: ${data.error}. ${data.suggestion || ''}`, 'bot');
                } else {
                    addChatMessage(data.reply, 'bot');
                }
                
            } catch (error) {
                addChatMessage('Lo siento, hubo un error procesando tu mensaje. Por favor intenta de nuevo.', 'bot');
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        function addChatMessage(text, type) {
            const messagesContainer = document.getElementById('chat-messages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}-message`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'bot' ? 'ü§ñ' : 'üë§';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = text;
            
            content.appendChild(textDiv);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Logout
        function handleLogout() {
            console.log('üö™ Cerrando sesi√≥n...');
            localStorage.removeItem('token');
            showToast('Sesi√≥n cerrada correctamente', 'success');
            setTimeout(() => {
                window.location.href = '/';
            }, 500);
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Dashboard cargado');
            
            if (!checkAuth()) return;
            
            await loadUserProfile();
            setupChatbot();
            loadDashboardData();
            
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
                console.log('‚úÖ Logout configurado');
            }
        });
    </script>
</body>
</html>